# キーマッピング

Vimのキーマッピングについて

## 概要

* キーの入力動作を変更するために使用する。
* Vimの各モードに応じたコマンドが用意されている。
* 再割り当ての有無でそれぞれ２つのコマンドがある。

| コマンド                 | モード                                     |
|--------------------------|--------------------------------------------|
| :map   :noremap  :unmap  | ノーマル、ビジュアル、選択、オペレータ待機 |
| :nmap  :nnoremap :nunmap | ノーマル                                   |
| :vmap  :vnoremap :vunmap | ビジュアル、選択                           |
| :smap  :snoremap :sunmap | 選択                                       |
| :xmap  :xnoremap :xunmap | ビジュアル                                 |
| :omap  :onoremap :ounmap | オペレータ待機                             |
| :map!  :noremap! :unmap! | 挿入、コマンドライン                       |
| :imap  :inoremap :iunmap | 挿入                                       |
| :lmap  :lnoremap :lunmap | 挿入、コマンドライン、Lang-Arg             |
| :cmap  :cnoremap :cunmap | コマンドライン                             |
| :tmap  :tnoremap :tunmap | 端末ジョブ                                 |

## 再割り当て有無の違いについて

* noreが付かないコマンドを使用すると、キーマッピングを展開したあと更に別のキーマッピングを展開する。
* 逆にnoreがつくコマンドを使用すると、１度だけ展開する。

### 再割り当ての例 （nmapとnnoremap）

Normalモードに置けるカーソルの上下移動を行う`j`と`k`を入れ替えるマッピングを例に検証する。

* 再割り当てありの場合

```vim
:nmap j k
:namp k j
```

1行目で下移動`j`を`k`にマッピングし、２行目で上移動`k`を`j`にマッピングしている。
これで、`j`と`k`の役割が入れ替わり、`j`で上移動、`k`で下移動となるはずだが、このマッピング設定は意図した通りに動作しない。
実際には以下のエラーメッセージが表示される。

    E223: recursive mapping

再帰的なマッピング、というメッセージの通り上の例では、マッピングの再割り当てが行われ、再帰的なマッピングの変換が行われてしまう。

    入力 `j` → （マッピング) → `k` → (マッピング) → `j` →  (以下ループ) ....

といったイメージでマッピングが処理される。`j`を`k`にマッピングしたものの、今度は`k`自体が`j`にマッピングされているため、Vimは再割り当てを行い、ループする事になる。

これを防ぐためには`nnoremap`を利用する。

* 再割り当てなしの場合

```vim
:nnoremap j k
:nnoremap k j
```

これは期待通り、`j`で上移動、`k`で下移動が行われる。`nore`をつけた場合はマッピングによるキーの割り当てを１度しか行わないため、`j`が`k`にマッピングされたあと、`k`のVim標準の動作が実施されることになる。

## 再割り当て有無の使い分け

基本的には、`nore`付きのマッピングを行うことで意図した通りの動作を行う。`nore`をつけない場合は、他のマッピングの影響を受けることになるため、意図した動きをしない可能性がある。

唯一の例外は、プラグインが提供するマッピング使用する場合となる。プラグインの中には、プラグインのもつ機能をあらかじめマッピングして提供している場合があり、これを使用する場合は、再割り当てありのコマンドを使用することになる。

```vim
nnoremap <Plug>(hogehoge) <C-u>call hoge()<CR>
```

みたいな機能が提供されていた場合に以下のようにマッピングしても意味がない。

```vim
nnoremap <Space>h <Plug>(hogehoge)
```

`nnoremap`は１度しかマッピングを行わないので、Vim標準`<Plug>(hogehoge)`という機能を探してしまい、当然そんなものはないので、何も起きない。
